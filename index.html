<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeChat | v3.1</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #3b82f6; --danger: #f43f5e; --warning: #f59e0b; --bg: #0a0a0b; --sidebar: #111113; --card: #18181b; }
        * { box-sizing: border-box; transition: all 0.2s ease; }
        body, html { margin: 0; padding: 0; height: 100vh; background: var(--bg); font-family: 'Plus Jakarta Sans', sans-serif; color: #e4e4e7; overflow: hidden; }

        /* Admin Overlay */
        #admin-overlay { 
            display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); 
            z-index: 9999; align-items: center; justify-content: center; backdrop-filter: blur(12px);
        }
        .admin-card { 
            background: var(--sidebar); border: 1px solid #27272a; width: 480px; padding: 32px; 
            border-radius: 24px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); position: relative;
        }
        .close-btn { position: absolute; top: 24px; right: 24px; cursor: pointer; color: #52525b; font-size: 20px; }

        /* Layout */
        #main-layout { display: grid; grid-template-columns: 320px 1fr; height: 100vh; display: none; }
        #sidebar { background: var(--sidebar); border-right: 1px solid #27272a; padding: 32px; display: flex; flex-direction: column; gap: 24px; }
        #chat-view { display: flex; flex-direction: column; height: 100vh; background: var(--bg); }
        #chat-logs { flex: 1; overflow-y: auto; padding: 40px; display: flex; flex-direction: column; gap: 16px; scroll-behavior: smooth; }
        
        /* Messages */
        .msg-box { padding: 16px 20px; border-radius: 16px; background: var(--card); border: 1px solid #27272a; max-width: 85%; align-self: flex-start; }
        .msg-box.me { align-self: flex-end; border-color: var(--primary); background: rgba(59, 130, 246, 0.1); }
        .sender-tag { font-family: 'JetBrains Mono'; font-size: 11px; font-weight: 800; color: var(--primary); margin-bottom: 6px; text-transform: uppercase; }

        /* UI Elements */
        input { background: #050506; border: 1px solid #27272a; border-radius: 12px; padding: 14px; color: #fff; outline: none; font-size: 14px; width: 100%; }
        input:focus { border-color: var(--primary); }
        .btn { background: var(--primary); color: white; border: none; padding: 14px; border-radius: 12px; font-weight: 700; cursor: pointer; font-size: 14px; }
        .btn-danger { background: var(--danger); }
        .btn-ghost { background: transparent; border: 1px solid #27272a; color: #a1a1aa; }

        #broadcast-banner { 
            display: none; position: fixed; top: 24px; left: 50%; transform: translateX(-50%);
            background: var(--danger); padding: 12px 32px; border-radius: 100px;
            z-index: 10000; font-weight: 800; box-shadow: 0 10px 25px rgba(244, 63, 94, 0.4);
            animation: slideIn 0.3s ease-out;
        }
        @keyframes slideIn { from { transform: translate(-50%, -100%); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }

        #user-table { margin-top: 12px; background: #050506; border-radius: 12px; border: 1px solid #27272a; max-height: 140px; overflow-y: auto; }
        .user-row { display: flex; justify-content: space-between; padding: 10px 16px; border-bottom: 1px solid #18181b; align-items: center; font-size: 13px; }
        #fx-layer { position: fixed; inset: 0; pointer-events: none; z-index: 9000; }
    </style>
</head>
<body>

<canvas id="fx-layer"></canvas>
<div id="broadcast-banner">ALERT: <span id="bc-text"></span></div>

<div id="admin-overlay">
    <div class="admin-card">
        <span class="close-btn" onclick="toggleAdmin()">‚úï</span>
        <h2 style="margin:0 0 8px; font-size:20px; font-weight:800;">Command Center</h2>
        <div id="user-table"></div>
        <div style="margin-top:20px;">
            <input type="text" id="bc-input" placeholder="Type global alert...">
            <button class="btn btn-danger" style="width:100%; margin-top:10px;" onclick="execute('bc')">BROADCAST WITH SOUND</button>
        </div>
        <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; margin-top:20px;">
            <button class="btn btn-ghost" onclick="execute('rain')">üí∞ Rain</button>
            <button class="btn btn-ghost" onclick="execute('matrix')">üß™ Matrix</button>
            <button class="btn btn-ghost" onclick="execute('glitch')">‚ò£Ô∏è Glitch</button>
            <button class="btn btn-ghost" id="mute-btn" onclick="execute('mute')">üîá Mute</button>
            <button class="btn btn-ghost" onclick="execute('wipe')">üßπ Wipe</button>
            <button class="btn btn-danger" onclick="execute('kick_all')">üíÄ Kill</button>
        </div>
    </div>
</div>

<div id="login-screen" style="position:fixed; inset:0; background:var(--bg); z-index:10001; display:flex; align-items:center; justify-content:center;">
    <div style="width:360px; text-align:center;">
        <h1 style="font-weight:900;">CodeChat</h1>
        <input type="text" id="user-id" placeholder="Display Name" style="margin-bottom:12px;">
        <input type="password" id="pass-id" placeholder="Admin Key">
        <button class="btn" style="margin-top:24px; width:100%;" onclick="startApp()">Initialize & Enable Audio</button>
    </div>
</div>

<div id="main-layout">
    <div id="sidebar">
        <h2 style="font-weight:900;">CodeChat</h2>
        <button class="btn btn-danger" id="admin-trigger" style="display:none;" onclick="toggleAdmin()">ADMIN PANEL</button>
        <input type="text" id="target-id" placeholder="Partner ID">
        <button class="btn" onclick="dial()">CONNECT</button>
        <div style="margin-top:auto;">
            <label style="font-size:10px; color:#52525b;">YOUR ID</label>
            <div id="my-id-display" style="font-family:'JetBrains Mono'; font-size:20px; color:var(--primary); font-weight:800;">------</div>
        </div>
    </div>
    <div id="chat-view">
        <div id="chat-logs"></div>
        <div style="padding:32px; background:rgba(10,10,11,0.8); backdrop-filter:blur(10px); display:flex; gap:16px; border-top:1px solid #27272a;">
            <input type="text" id="chat-input" placeholder="Transmission...">
            <button class="btn" style="width:120px;" onclick="post()">SEND</button>
        </div>
    </div>
</div>

<script>
    const d=document, KEY = "AdminBingkahu2014!";
    let me="", isAdmin=false, myPeer, peerConns = {}, isMuted=false;

    // --- Audio Engine ---
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playSound(type) {
        const osc = audioCtx.createOscillator();
        const gain = audioCtx.createGain();
        osc.connect(gain);
        gain.connect(audioCtx.destination);

        if(type === 'msg') {
            osc.type = 'sine';
            osc.frequency.setValueAtTime(880, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(440, audioCtx.currentTime + 0.1);
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
            osc.start(); osc.stop(audioCtx.currentTime + 0.1);
        } else if (type === 'admin') {
            osc.type = 'square';
            osc.frequency.setValueAtTime(110, audioCtx.currentTime);
            osc.frequency.linearRampToValueAtTime(220, audioCtx.currentTime + 0.2);
            gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.3);
            osc.start(); osc.stop(audioCtx.currentTime + 0.3);
        }
    }

    function startApp() {
        me = d.getElementById('user-id').value || "Guest";
        if(d.getElementById('pass-id').value === KEY) { isAdmin=true; d.getElementById('admin-trigger').style.display='block'; }
        audioCtx.resume(); // Unlock audio on user gesture
        d.getElementById('login-screen').style.display='none';
        d.getElementById('main-layout').style.display='grid';
        initPeer();
    }

    function toggleAdmin() { d.getElementById('admin-overlay').style.display = (d.getElementById('admin-overlay').style.display==='flex') ? 'none' : 'flex'; }

    function initPeer() {
        myPeer = new Peer(Math.random().toString(36).substr(2, 6).toUpperCase());
        myPeer.on('open', i => d.getElementById('my-id-display').innerText = i);
        myPeer.on('connection', c => handleConn(c));
    }

    function dial() { handleConn(myPeer.connect(d.getElementById('target-id').value.toUpperCase())); }

    function handleConn(conn) {
        conn.on('open', () => {
            peerConns[conn.peer] = { conn, name: "Node" };
            conn.send({type: 'SYNC', name: me});
            refreshUserList();
        });
        conn.on('data', data => {
            if(data.type === 'SYNC') { peerConns[conn.peer].name = data.name; refreshUserList(); }
            if(data.type === 'MSG') { renderMsg(data.name, data.text); playSound('msg'); }
            if(data.type === 'BC') { doBC(data.val); playSound('admin'); }
            if(data.type === 'FX') startFX(data.mode);
            if(data.type === 'MUTE') { isMuted = data.val; d.getElementById('chat-input').disabled = isMuted; }
            if(data.type === 'WIPE') d.getElementById('chat-logs').innerHTML = "";
            if(data.type === 'KILL') location.reload();
        });
    }

    function refreshUserList() {
        const t = d.getElementById('user-table'); t.innerHTML = "";
        for(let id in peerConns) {
            t.innerHTML += `<div class="user-row"><span>${peerConns[id].name}</span><button class="btn btn-danger" style="padding:4px 10px; font-size:10px;" onclick="kick('${id}')">KICK</button></div>`;
        }
    }

    function kick(id) { if(peerConns[id]) peerConns[id].conn.send({type:'KILL'}); }

    function execute(cmd) {
        const val = d.getElementById('bc-input').value;
        for(let id in peerConns) {
            let c = peerConns[id].conn;
            if(cmd==='bc') c.send({type:'BC', val});
            if(cmd==='rain' || cmd==='matrix' || cmd==='glitch') c.send({type:'FX', mode:cmd});
            if(cmd==='mute') { isMuted=!isMuted; c.send({type:'MUTE', val:isMuted}); }
            if(cmd==='wipe') c.send({type:'WIPE'});
            if(cmd==='kick_all') c.send({type:'KILL'});
        }
        if(cmd==='bc') { doBC(val); playSound('admin'); }
        if(cmd==='rain' || cmd==='matrix') startFX(cmd);
        if(cmd==='wipe') d.getElementById('chat-logs').innerHTML = "";
    }

    function doBC(v) { d.getElementById('bc-text').innerText = v; d.getElementById('broadcast-banner').style.display='block'; setTimeout(()=>d.getElementById('broadcast-banner').style.display='none', 8000); }
    
    function renderMsg(n, t) {
        const b = d.createElement('div');
        b.className = `msg-box ${n===me ? 'me' : ''}`;
        b.innerHTML = `<div class="sender-tag">${n}</div><div>${t}</div>`;
        d.getElementById('chat-logs').appendChild(b);
        d.getElementById('chat-logs').scrollTop = d.getElementById('chat-logs').scrollHeight;
    }

    function post() {
        const i = d.getElementById('chat-input');
        if(!i.value || isMuted) return;
        for(let id in peerConns) peerConns[id].conn.send({type:'MSG', name:me, text:i.value});
        renderMsg(me, i.value); i.value="";
    }

    const canv = d.getElementById('fx-layer'), cx = canv.getContext('2d');
    canv.width = window.innerWidth; canv.height = window.innerHeight;
    function startFX(m) {
        let p = []; for(let i=0; i<60; i++) p.push({x:Math.random()*canv.width, y:-Math.random()*1000, s:Math.random()*5+3});
        const run = () => {
            cx.clearRect(0,0,canv.width, canv.height);
            let active = false;
            p.forEach(item => {
                item.y += item.s; if(item.y < canv.height+20) active = true;
                cx.fillStyle = m==='rain' ? '#fbbf24' : '#22c55e';
                if(m==='rain') { cx.beginPath(); cx.arc(item.x, item.y, 5, 0, 7); cx.fill(); }
                else { cx.font='14px monospace'; cx.fillText(String.fromCharCode(0x30A0 + Math.random()*96), item.x, item.y); }
            });
            if(active) requestAnimationFrame(run);
        }; run();
    }
    d.onkeypress = (e) => { if(e.key==='Enter') post(); };
</script>
</body>
</html>
