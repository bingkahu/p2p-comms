<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>CodeChat | v4.9 Apex Ultra</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;800&family=JetBrains+Mono&display=swap" rel="stylesheet">
    <style>
        :root { --primary: #3b82f6; --danger: #f43f5e; --success: #22c55e; --bg: #050506; --sidebar: #0f0f12; --panel: #16161a; }
        * { box-sizing: border-box; transition: all 0.2s ease; }
        body, html { margin: 0; padding: 0; height: 100vh; background: var(--bg); font-family: 'Plus Jakarta Sans', sans-serif; color: #ececed; overflow: hidden; }

        /* --- UI Shell --- */
        #app-shell { display: grid; grid-template-columns: 320px 1fr; height: 100vh; display: none; }
        #nav-bar { background: var(--sidebar); border-right: 1px solid #27272a; padding: 30px; display: flex; flex-direction: column; }
        #chat-stage { display: flex; flex-direction: column; height: 100vh; background: var(--bg); position: relative; }

        /* --- Chat Stream --- */
        #message-stream { flex: 1; overflow-y: auto; padding: 40px; display: flex; flex-direction: column; gap: 12px; scroll-behavior: smooth; }
        #message-stream::-webkit-scrollbar { width: 5px; }
        #message-stream::-webkit-scrollbar-thumb { background: #27272a; border-radius: 10px; }

        .bubble { padding: 14px 20px; border-radius: 18px; background: var(--panel); border: 1px solid #222; max-width: 75%; width: fit-content; }
        .bubble.me { align-self: flex-end; background: var(--primary); color: white; border: none; }
        .tag { font-size: 10px; font-weight: 800; opacity: 0.5; margin-bottom: 4px; text-transform: uppercase; }

        /* --- Buttons & Inputs --- */
        input { background: #0b0b0d; border: 1px solid #27272a; border-radius: 14px; padding: 16px; color: #fff; outline: none; width: 100%; font-size: 14px; }
        .btn { background: var(--primary); color: white; border: none; padding: 14px; border-radius: 14px; font-weight: 700; cursor: pointer; text-align: center; }
        .btn-danger { background: var(--danger); }
        .btn-logout { background: transparent; border: 1px solid #333; color: #555; font-size: 12px; margin-top: 20px; text-transform: uppercase; letter-spacing: 1px; }
        .btn-logout:hover { border-color: var(--danger); color: var(--danger); }

        /* --- Status Components --- */
        #alert-strip { display: none; position: fixed; top: 0; left: 0; width: 100%; background: var(--danger); padding: 12px; text-align: center; z-index: 9999; font-weight: 900; }
        .status-pill { display: none; align-items: center; padding: 5px 12px; border-radius: 100px; font-size: 10px; font-weight: 800; background: rgba(34, 197, 94, 0.1); color: var(--success); border: 1px solid rgba(34, 197, 94, 0.2); }
        .entry-link { display: block; margin-top: 20px; font-size: 12px; color: #555; text-decoration: none; cursor: pointer; }
        .entry-link:hover { color: var(--primary); }

        /* --- Admin --- */
        #admin-modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.98); z-index: 10000; align-items: center; justify-content: center; backdrop-filter: blur(25px); }
        .admin-box { background: var(--sidebar); border: 1px solid #27272a; width: 900px; height: 640px; display: grid; grid-template-columns: 280px 1fr; border-radius: 35px; overflow: hidden; }
        .aside, .main { padding: 35px; }
    </style>
</head>
<body>

<canvas id="fx-canvas" style="position:fixed; inset:0; pointer-events:none; z-index:9000;"></canvas>
<div id="alert-strip">‚ö†Ô∏è SYSTEM: <span id="alert-msg"></span></div>

<div id="admin-modal">
    <div class="admin-box">
        <div class="aside">
            <h2 style="margin:0 0 5px;">Root Console</h2>
            <div id="node-list" style="overflow-y:auto; flex:1; margin-top:20px;"></div>
            <button class="btn" style="background:#222; margin-top:20px; width:100%;" onclick="toggleAdmin(false)">Close Console</button>
        </div>
        <div class="main" style="display:flex; flex-direction:column;">
            <div id="log-window" style="flex:1; background:#000; border:1px solid #222; border-radius:16px; font-family:monospace; padding:20px; overflow-y:auto; color:#71717a; margin-bottom:20px;"></div>
            <input type="text" id="bc-field" placeholder="Admin message..." style="margin-bottom:12px;">
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                <button class="btn btn-danger" onclick="runCmd('bc')" style="grid-column: span 2;">üì¢ Broadcast with Alert</button>
                <button class="btn" onclick="runCmd('rain')" style="background:#fbbf24; color:#000;">üí∞ Rain FX</button>
                <button class="btn" onclick="runCmd('matrix')" style="background:#a855f7;">üß™ Matrix FX</button>
                <button class="btn btn-danger" onclick="runCmd('kill')">üíÄ Kill All</button>
            </div>
        </div>
    </div>
</div>

<div id="entry-gate" style="position:fixed; inset:0; background:var(--bg); z-index:10001; display:flex; align-items:center; justify-content:center;">
    <div style="width:360px; text-align:center; background:var(--panel); padding:50px; border-radius:40px; border:1px solid #222;">
        <h1 style="margin-bottom:8px; font-weight:900;">CodeChat</h1>
        <p style="font-size:12px; color:#555; margin-bottom:35px;">Secure Mesh Networking</p>
        <input type="text" id="u-name" placeholder="Username" style="margin-bottom:12px;">
        <input type="password" id="u-pass" placeholder="Password" style="margin-bottom:12px;">
        <button class="btn" style="width:100%; margin-top:25px;" onclick="init()">Log In</button>
        <a class="entry-link" onclick="alert('Account creation currently disabled. Contact system admin.')">Create Account</a>
    </div>
</div>

<div id="app-shell">
    <div id="nav-bar">
        <h2 style="font-weight:900; margin:0 0 30px;">CodeChat</h2>
        <button class="btn btn-danger" id="adm-btn" style="display:none; margin-bottom:30px;" onclick="toggleAdmin(true)">ROOT CONSOLE</button>
        
        <label style="font-size:10px; color:#555; font-weight:800;">LINK REMOTE NODE</label>
        <input type="text" id="target-id" placeholder="Enter ID..." style="margin:10px 0;">
        <button class="btn" onclick="connect()">Connect to Node</button>

        <div style="margin-top:auto;">
            <div id="sys-status" class="status-pill">‚óè SYSTEM: ONLINE</div>
            <div style="height:20px;"></div>
            <label style="font-size:10px; color:#555;">MY NODE ID</label>
            <div id="my-id" style="font-family:'JetBrains Mono'; color:var(--primary); font-weight:800; font-size:24px; background:#000; padding:18px; border-radius:16px; border:1px solid #222; text-align:center;">---</div>
            <button class="btn btn-logout" onclick="logout()">LOG OUT</button>
        </div>
    </div>
    <div id="chat-stage">
        <div id="message-stream"></div>
        <div style="padding:35px; background:rgba(15,15,18,0.95); display:flex; gap:15px; border-top:1px solid #222;">
            <input type="text" id="msg-in" placeholder="Type a message...">
            <button class="btn" style="width:120px;" onclick="send()">SEND</button>
        </div>
    </div>
</div>

<script>
    const d=document, ADMIN_PASS = "AdminBingkahu2014!";
    let user="", isAdmin=false, myPeer, conns = {};

    const audio = new (window.AudioContext || window.webkitAudioContext)();
    function sfx(f) {
        const o=audio.createOscillator(), g=audio.createGain();
        o.connect(g); g.connect(audio.destination);
        o.type='square'; o.frequency.setValueAtTime(f, audio.currentTime);
        g.gain.setValueAtTime(0.05, audio.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, audio.currentTime+0.5);
        o.start(); o.stop(audio.currentTime+0.5);
    }

    function init() {
        user = d.getElementById('u-name').value || "Guest";
        if(d.getElementById('u-pass').value === ADMIN_PASS) { isAdmin=true; d.getElementById('adm-btn').style.display='block'; }
        audio.resume();
        d.getElementById('entry-gate').style.display='none';
        d.getElementById('app-shell').style.display='grid';
        
        myPeer = new Peer(Math.random().toString(36).substr(2, 6).toUpperCase());
        myPeer.on('open', id => d.getElementById('my-id').innerText = id);
        myPeer.on('connection', c => bind(c));
    }

    function logout() { if(myPeer) myPeer.destroy(); location.reload(); }
    function connect() { bind(myPeer.connect(d.getElementById('target-id').value.toUpperCase())); }

    function bind(c) {
        c.on('open', () => {
            conns[c.peer] = { conn: c, name: "Node" };
            c.send({type:'SYNC', name:user});
            d.getElementById('sys-status').style.display = 'inline-flex';
            if(isAdmin) log(`Handshake: ${c.peer}`, "#3b82f6");
            updateAdmin();
        });
        c.on('data', data => {
            if(data.type==='SYNC') { conns[c.peer].name = data.name; updateAdmin(); }
            if(data.type==='MSG') post(data.name, data.text);
            if(data.type==='BC') { showAlert(data.val); sfx(400); }
            if(data.type==='FX') { fx(data.mode); sfx(600); }
            if(data.type==='KILL') logout();
        });
        c.on('close', () => { 
            delete conns[c.peer]; 
            if(Object.keys(conns).length === 0) d.getElementById('sys-status').style.display = 'none';
            updateAdmin(); 
        });
    }

    function post(n, t) {
        const stream = d.getElementById('message-stream');
        const b = d.createElement('div');
        b.className = `bubble ${n===user ? 'me' : ''}`;
        b.innerHTML = `<div class="tag">${n}</div><div>${t}</div>`;
        stream.appendChild(b);
        stream.scrollTop = stream.scrollHeight;
    }

    function send() {
        const i = d.getElementById('msg-in'); if(!i.value) return;
        for(let id in conns) conns[id].conn.send({type:'MSG', name:user, text:i.value});
        post(user, i.value); i.value="";
    }

    function log(m, c="#71717a") {
        const w = d.getElementById('log-window'); if(!w) return;
        w.innerHTML += `<div style="margin-bottom:6px; color:${c}">[${new Date().toLocaleTimeString()}] ${m}</div>`;
        w.scrollTop = w.scrollHeight;
    }

    function updateAdmin() {
        if(!isAdmin) return;
        const list = d.getElementById('node-list');
        list.innerHTML = "";
        Object.keys(conns).forEach(id => {
            list.innerHTML += `<div style="padding:10px; background:#000; margin-bottom:8px; border-radius:12px; font-size:11px; display:flex; justify-content:space-between; border:1px solid #222;">
                <span>${conns[id].name}</span> <span onclick="runCmd('kill','${id}')" style="color:var(--danger); cursor:pointer;">KICK</span></div>`;
        });
    }

    function runCmd(type, targetId = null) {
        const val = d.getElementById('bc-field').value;
        const targets = targetId ? [targetId] : Object.keys(conns);
        targets.forEach(id => {
            const c = conns[id].conn;
            if(type==='bc') c.send({type:'BC', val});
            if(type==='rain' || type==='matrix') c.send({type:'FX', mode:type});
            if(type==='kill') c.send({type:'KILL'});
        });
        if(!targetId) {
            if(type==='bc') { showAlert(val); sfx(400); }
            if(type==='rain' || type==='matrix') fx(type);
            log(`GLOBAL ${type.toUpperCase()}`, "#fbbf24");
        }
    }

    function toggleAdmin(s) { d.getElementById('admin-modal').style.display = s ? 'flex' : 'none'; }
    function showAlert(v) { d.getElementById('alert-msg').innerText = v; d.getElementById('alert-strip').style.display='block'; setTimeout(()=>d.getElementById('alert-strip').style.display='none', 8000); }
    
    function fx(m) {
        const cv = d.getElementById('fx-canvas'), cx = cv.getContext('2d');
        cv.width = window.innerWidth; cv.height = window.innerHeight;
        let p = []; for(let i=0; i<80; i++) p.push({x:Math.random()*cv.width, y:-50, s:Math.random()*7+5});
        function draw() {
            cx.clearRect(0,0,cv.width,cv.height);
            let a = false;
            p.forEach(it => {
                it.y += it.s; if(it.y < cv.height) a = true;
                cx.fillStyle = (m==='rain'?'#fbbf24':'#22c55e');
                cx.fillText(m==='rain'?'$':String.fromCharCode(0x30A0+Math.random()*96), it.x, it.y);
            });
            if(a) requestAnimationFrame(draw);
        } draw();
    }
    d.getElementById('msg-in').onkeydown = e => { if(e.key==='Enter') send(); };
</script>
</body>
</html>
